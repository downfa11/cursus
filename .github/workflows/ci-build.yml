name: CI/ Lint (pull_request & push)  
  
on:  
  push:  
    branches: [main, release-*]  
  pull_request:  
    branches: [main, release-*]  
  
jobs:  
  setup:  
    runs-on: ubuntu-latest  
    outputs:  
      go-path: ${{ steps.go-path.outputs.go-path }}  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-go@v5  
        with:  
          go-version: '1.25.0'  
      - name: Cache Go modules  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.cache/go-build  
            ~/go/pkg/mod  
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}  
  
  lint:  
    runs-on: ubuntu-latest  
    needs: setup  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-go@v5  
        with:  
          go-version: '1.25.0'  
      - name: Restore cache  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.cache/go-build  
            ~/go/pkg/mod  
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}  
      - run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest  
      - run: make lint  
  
  test:  
    runs-on: ubuntu-latest  
    needs: setup  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-go@v5  
        with:  
          go-version: '1.25.0'  
      - name: Restore cache  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.cache/go-build  
            ~/go/pkg/mod  
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}  
      - name: Run tests with coverage  
        run: make coverage   
      - name: Upload coverage reports to Codecov  
        uses: codecov/codecov-action@v5  
        with:  
          files: ./coverage.out  
          
  build:  
    runs-on: ubuntu-latest  
    needs: setup  
    steps:  
      - uses: actions/checkout@v4  
      - uses: actions/setup-go@v5  
        with:  
          go-version: '1.25.0'  
      - name: Restore cache  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.cache/go-build  
            ~/go/pkg/mod  
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}  
      - run: make build  
    
  e2e:    
    runs-on: ubuntu-latest    
    needs: setup  
    timeout-minutes: 15  
    steps:    
      - uses: actions/checkout@v4    
      - uses: actions/setup-go@v5    
        with:    
          go-version: '1.25.0'  
      - name: Restore cache  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.cache/go-build  
            ~/go/pkg/mod  
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}  
      - run: make e2e  
      - name: Upload E2E logs on failure  
        if: failure()  
        uses: actions/upload-artifact@v4  
        with:  
          name: e2e-logs  
          path: test/logs/